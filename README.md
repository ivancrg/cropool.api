# cropool.api

API for [cropool](https://github.com/MSrica/cropool) Android Application.

## Main

### `index.js`

Main file, run with `npm start`.

### Register

#### `/register`
POST. Expects JSON object with `first_name`, `last_name`, `e_mail`, hashed `password` objects. Short description:

* Tries to find the user specified by JSON object in the database:
    * On error: send response with HTTP 500 status and feedback string
    * On success:
        * If a user with the wanted e-mail address already exists: send response with HTTP 409 status and feedback string
        * If the wanted e-mail address isn't used by anyone: try to insert the new user specified by JSON object to the database:
            * On error: send response with HTTP 500 status and feedback string
            * On success: send response with HTTP 201 status, feedback string and header that includes access and refresh JWT tokens generated using [`generateAccessJWT`](#generate-access-token), [`generateRefreshJWT`](#generate-refresh-token) and [`registerUserGenerateFirebaseJWT`](#register-user-and-generate-firebase-token)

### Login

#### `/login`
POST. Expects JSON object with `e_mail` and `password` objects. Short description:

* Tries to get info of the user with e-mail address specified by JSON object:
    * On error: send response with HTTP 500 status and feedback string
    * On success:
        * If a user with the wanted e-mail address doesn't exist: send response with HTTP 404 status and feedback string
        * If a user with the wanted e-mail address exists: try to compare provided `password` with database's hashed password:
        * On error: send response with HTTP 500 status and feedback string
        * On success:
            * If the passwords match: send response with HTTP 201 status, feedback string and header that includes access and refresh JWT tokens generated using [`generateAccessJWT`](#generate-access-token), [`generateRefreshJWT`](#generate-refresh-token) and [`generateFirebaseJWT`](#generate-firebase-token)
            * If the passwords don't match: send response with HTTP 403 status and feedback string

### Logout

#### `/logout`
PATCH. Expects JSON object with `e_mail` object. Short description:

* Tries to update last logout timestamp of a user with `e_mail` e-mail address:
    * On error: send response with HTTP 500 status and feedback string
    * On success: send response with HTTP 201 status and feedback string

### Access and Firebase tokens

#### `/tokens`
GET. Expects `refresh_token` in request header. Short description:
* Checks whether the provided refresh JWT is valid using [`authenticateRefreshToken`](#authenticate-refresh-token):
    * If the token isn't valid: `token_management.js` middleware handles sending the response
    * If the token is valid: send response with HTTP 201 status, feedback string and header that includes access and Firebase tokens in header generated by `token_management.js`

### Account info

#### `/accountInfo`
GET. Expects `access_token` and `firebase_token` in request header. Short description:
* Checks whether the provided tokens are valid using [`authenticateAccessToken`](#authenticate-access-token) and [`authenticateFirebaseToken`](#authenticate-firebase-token):
    * If a token isn't valid: `token_management.js` middleware handles sending the response
    * If the tokens are valid: respond with user info in form of a JSON object consisting of user's first name, last name and profile picture URL

### Update info

#### `/updateInfo`
Patch. Expects `access_token` and `firebase_token` in request header. Expects both first and last name or profile picture URL (or all three values) in the request body. Short description:
* Checks whether the provided tokens are valid using [`authenticateAccessToken`](#authenticate-access-token) and [`authenticateFirebaseToken`](#authenticate-firebase-token):
    * If a token isn't valid: `token_management.js` middleware handles sending the response
    * If the tokens are valid: update provided values in cropool.api database, Firebase RTDB and Firebase AUTHDB's first name, last name and profile picture URL

### Update password

#### `/changePassword`
Patch. Expects `access_token` in request header. Expects current and new passsword in the request body with possible option `logout_required` that should be of boolean type. Short description:
* Checks whether the provided token is valid using [`authenticateAccessToken`](#authenticate-access-token) and whether the current password is correct:
    * If a token isn't valid or current password isn't correct: `token_management.js` middleware handles sending the response or 403 HTTP status + feedback
    * If the token is valid and current password is correct: update password in cropool.api database, logout from all devices if required


## Token management

### `token_management.js`
Used to store [JWT](https://jwt.io) utility functions.

### Generate access token

#### `generateAccessJWT(email)`
Generates access JWT that will belong to user with e-mail address `email` and will expire in 10 minutes.

### Generate refresh token

#### `generateRefreshJWT(email)`
Generates refresh JWT that will belong to user with e-mail address `email` and will expire in 7 days.

### Generate Firebase token

#### `generateFirebaseJWT(email, callback)`
Generates Firebase JWT that will belong to user with e-mail address `email` and will be used to authenticate with Firebase service.

### Register user and generate Firebase token

#### `registerUserGenerateFirebaseJWT(iduser, email, displayName, callback)`
Generates Firebase JWT that will belong to user with e-mail address `email` and will be used to authenticate with Firebase service. If the user wasn't registered to Firebase yet, a new user with an UID 'iduser' is created. His e-mail address is 'email' and his display name is 'displayName'.

### Authenticate token

#### `authenticateToken(tokenName, req, res, next)`

Expects an refresh/access JWT in request's `tokenName` header (format "Bearer \<token\>"). Middleware used for authenticating refresh/access tokens with API endpoints that respond with user-specific sensitive information. Short description:
* Checks whether the token is null:
    * If the token is null: send response with HTTP 401 status
    * If the token isn't null: check whether the token is valid:
        * If the token isn't valid: send response with HTTP 403 status
        * If the token is valid: check whether the token was issued after user's creation timestamp and user's last logout timestamp:
            * If the token was created before any of the mentioned timestamps: send response with HTTP 403 status and feedback string
            * If the token was created after both of the mentioned timestamps:  forward `user` identified in token with `next()`

### Authenticate access token

#### `authenticateAccessToken(req, res, next)`

Executes `authenticateToken("access_token", req, res, next)`.

### Authenticate refresh token

#### `authenticateRefreshToken(req, res, next)`

Executes `authenticateToken("refresh_token", req, res, next)`.

### Authenticate firebase token

#### `authenticateFirebaseToken(req, res, next)`

Expects an Firebase JWT in request's `firebase_token` header (format "Bearer \<token\>") and user's e-mail address in 'req.user.e_mail' field. Middleware used for authenticating access tokens with API endpoints that respond with/to Firebase user-specific sensitive information. Short description:
* Checks whether the token is null:
    * If the token is null: send response with HTTP 401 status
    * If the token isn't null: check whether the token is valid:
        * If the token isn't valid: send response with HTTP 403 status
        * If the token is valid: check whether the token's UID corresponds to previously authenticated 'user.e_mail' and whether the token was issued after user's creation timestamp and user's last logout timestamp:
            * If the token was created before any of the mentioned timestamps or UID and e-mail don't match: send response with HTTP 403 status and feedback string
            * If the token was created after both of the mentioned timestamps and UID and e-mail match: forward user's `uid` identified in token with `next()`